#!/bin/bash

# Lucidity Delivery Optimization System - Startup Script
# Usage: ./lucidity delivery-optimization-system start

set -e

COMMAND=$1
ACTION=$2

if [ "$COMMAND" != "delivery-optimization-system" ] || [ "$ACTION" != "start" ]; then
    echo "Usage: ./lucidity delivery-optimization-system start"
    exit 1
fi

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}╔═══════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║   Lucidity Delivery Route Optimization System            ║${NC}"
echo -e "${BLUE}╚═══════════════════════════════════════════════════════════╝${NC}"
echo ""

# Step 1: Check prerequisites
echo -e "${YELLOW}[1/5]${NC} Checking prerequisites..."
if ! command -v docker &> /dev/null; then
    echo "Error: Docker is not installed"
    exit 1
fi
if ! command -v docker compose &> /dev/null; then
    echo "Error: Docker Compose is not installed"
    exit 1
fi
echo -e "${GREEN}✓${NC} Docker and Docker Compose found"
echo ""

# Step 2: Start infrastructure services
echo -e "${YELLOW}[2/5]${NC} Starting infrastructure services (PostgreSQL, Redis, Kafka)..."
cd infrastructure
docker compose down > /dev/null 2>&1 || true
docker compose up -d postgres redis zookeeper kafka > /dev/null 2>&1
echo -e "${GREEN}✓${NC} Infrastructure services started"
echo ""

# Wait for infrastructure
echo -e "${YELLOW}[3/5]${NC} Waiting for services to be healthy (30s)..."
sleep 30
echo -e "${GREEN}✓${NC} Infrastructure ready"
echo ""

# Step 3: Start application services
echo -e "${YELLOW}[4/5]${NC} Starting application services (Order, Routing, Monitoring)..."
docker compose up -d order-service routing-service prometheus grafana > /dev/null 2>&1
echo -e "${GREEN}✓${NC} Application services started"
echo ""

# Wait for application services
echo "Waiting for services to initialize (40s)..."
sleep 40

# Step 4: Run integration tests
echo -e "${YELLOW}[5/5]${NC} Running integration tests..."
echo ""
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}                    TEST EXECUTION                         ${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""
echo "This test validates the entire system end-to-end:"
echo "  • Creates 3 orders with different delivery locations"
echo "  • Optimizes route using TSP algorithms"
echo "  • Verifies pickup-before-delivery constraints"
echo "  • Assigns batch to delivery executive"
echo "  • Validates route distance and time calculations"
echo ""

cd ..
chmod +x test-api.sh
./test-api.sh

TEST_EXIT_CODE=$?
echo ""

if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}✓${NC} All tests passed!"
else
    echo -e "Tests completed with some failures (see above for details)"
fi

echo ""
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}                  SYSTEM READY                             ${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""
echo "Services Running:"
echo "  • Order Service:     http://localhost:8081"
echo "  • Routing Service:   http://localhost:8082"
echo "  • Prometheus:        http://localhost:9090"
echo "  • Grafana:           http://localhost:3000 (admin/admin)"
echo ""
echo "Opening Grafana Dashboards..."
echo ""

# Open Grafana dashboards
sleep 3

# Try different browsers
if command -v open &> /dev/null; then
    # macOS
    open "http://localhost:3000/d/order-service-dashboard/order-service-performance-dashboard?orgId=1&from=now-15m&to=now&timezone=browser&refresh=10s" > /dev/null 2>&1 &
    sleep 2
    open "http://localhost:3000/d/routing-service-dashboard/routing-service-performance-dashboard?orgId=1&from=now-15m&to=now&timezone=browser&refresh=10s" > /dev/null 2>&1 &
elif command -v xdg-open &> /dev/null; then
    # Linux
    xdg-open "http://localhost:3000/d/order-service-dashboard/order-service-performance-dashboard?orgId=1&from=now-15m&to=now&timezone=browser&refresh=10s" > /dev/null 2>&1 &
    sleep 2
    xdg-open "http://localhost:3000/d/routing-service-dashboard/routing-service-performance-dashboard?orgId=1&from=now-15m&to=now&timezone=browser&refresh=10s" > /dev/null 2>&1 &
else
    echo "Could not automatically open browser. Please visit:"
    echo "  http://localhost:3000/d/order-service-dashboard"
    echo "  http://localhost:3000/d/routing-service-dashboard"
fi

echo -e "${GREEN}✓${NC} Dashboards opened in browser"
echo ""
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""
echo "System is ready for use!"
echo ""
echo "To stop all services:"
echo "  cd infrastructure && docker compose down"
echo ""

